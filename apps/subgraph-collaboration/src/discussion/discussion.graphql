extend schema
  @link(url: "https://specs.apollo.dev/federation/v2.7", import: ["@key", "@shareable", "@external", "@authenticated"])

"""Discussion types"""
enum DiscussionType {
  FORUM
  CHAVRUTA
  DEBATE
}

"""Message types"""
enum MessageType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
}

"""Discussion in a course"""
type Discussion @key(fields: "id") {
  id: ID!
  courseId: ID!
  course: Course!
  title: String!
  description: String
  creatorId: ID!
  creator: User!
  discussionType: DiscussionType!
  messages(limit: Int = 50, offset: Int = 0): [DiscussionMessage!]!
  participants: [DiscussionParticipant!]!
  participantCount: Int!
  messageCount: Int!
  createdAt: DateTime!
  updatedAt: DateTime!
}

"""Message in a discussion"""
type DiscussionMessage @key(fields: "id") {
  id: ID!
  discussionId: ID!
  discussion: Discussion!
  userId: ID!
  user: User!
  content: String!
  messageType: MessageType!
  parentMessageId: ID
  parentMessage: DiscussionMessage
  replies(limit: Int = 20, offset: Int = 0): [DiscussionMessage!]!
  replyCount: Int!
  createdAt: DateTime!
  updatedAt: DateTime!
}

"""Participant in a discussion"""
type DiscussionParticipant {
  id: ID!
  discussionId: ID!
  discussion: Discussion!
  userId: ID!
  user: User!
  joinedAt: DateTime!
}

"""External entity stubs"""
type User @key(fields: "id") {
  id: ID!
}

type Course @key(fields: "id") {
  id: ID!
}

extend type Query {
  """Get a single discussion by ID"""
  discussion(id: ID!): Discussion @authenticated

  """Get all discussions for a course"""
  discussions(courseId: ID!, limit: Int = 20, offset: Int = 0): [Discussion!]! @authenticated

  """Get all discussions the current user has participated in"""
  myDiscussions(limit: Int = 20, offset: Int = 0): [Discussion!]! @authenticated

  """Get all messages in a discussion"""
  discussionMessages(discussionId: ID!, limit: Int = 50, offset: Int = 0): [DiscussionMessage!]! @authenticated
}

extend type Mutation {
  """Create a new discussion"""
  createDiscussion(input: CreateDiscussionInput!): Discussion! @authenticated

  """Add a message to a discussion"""
  addMessage(discussionId: ID!, input: AddMessageInput!): DiscussionMessage! @authenticated

  """Join a discussion as a participant"""
  joinDiscussion(discussionId: ID!): Boolean! @authenticated

  """Leave a discussion"""
  leaveDiscussion(discussionId: ID!): Boolean! @authenticated
}

type Subscription {
  """Subscribe to new messages in a discussion"""
  messageAdded(discussionId: ID!): DiscussionMessage!
}

input CreateDiscussionInput {
  courseId: ID!
  title: String!
  description: String
  discussionType: DiscussionType!
}

input AddMessageInput {
  content: String!
  messageType: MessageType!
  parentMessageId: ID
}

scalar DateTime
