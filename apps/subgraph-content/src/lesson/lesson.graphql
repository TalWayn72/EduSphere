# ─── Lesson Pipeline Builder SDL ─────────────────────────────────────────────
# Lesson types live in subgraph-content and extend the Course/Module entities.
# typePaths: './**/*.graphql' picks this up automatically in the NestJS module.

enum LessonType {
  THEMATIC
  SEQUENTIAL
}

enum LessonStatus {
  DRAFT
  PROCESSING
  READY
  PUBLISHED
}

enum LessonAssetType {
  VIDEO
  AUDIO
  NOTES
  WHITEBOARD
}

enum PipelineModuleType {
  INGESTION
  ASR
  NER_SOURCE_LINKING
  CONTENT_CLEANING
  SUMMARIZATION
  STRUCTURED_NOTES
  DIAGRAM_GENERATOR
  CITATION_VERIFIER
  QA_GATE
  PUBLISH_SHARE
}

enum PipelineStatus {
  DRAFT
  READY
  RUNNING
  COMPLETED
  FAILED
}

enum RunStatus {
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum CitationMatchStatus {
  VERIFIED
  UNVERIFIED
  FAILED
}

type Lesson @key(fields: "id") {
  id: ID!
  courseId: ID!
  moduleId: ID
  title: String!
  type: LessonType!
  series: String
  lessonDate: String
  instructorId: ID!
  status: LessonStatus!
  assets: [LessonAsset!]!
  pipeline: LessonPipeline
  citations: [LessonCitation!]!
  createdAt: String!
  updatedAt: String!
}

type LessonAsset {
  id: ID!
  lessonId: ID!
  assetType: LessonAssetType!
  sourceUrl: String
  fileUrl: String
  mediaAssetId: ID
  metadata: JSON
}

type LessonPipeline {
  id: ID!
  lessonId: ID!
  templateName: String
  nodes: JSON!
  config: JSON
  status: PipelineStatus!
  currentRun: LessonPipelineRun
  createdAt: String!
}

type LessonPipelineRun {
  id: ID!
  pipelineId: ID!
  startedAt: String
  completedAt: String
  status: RunStatus!
  logs: JSON
  results: [LessonPipelineResult!]!
}

type LessonPipelineResult {
  id: ID!
  runId: ID!
  moduleName: String!
  outputType: String!
  outputData: JSON
  fileUrl: String
  createdAt: String!
}

type LessonCitation {
  id: ID!
  lessonId: ID!
  sourceText: String!
  bookName: String!
  part: String
  page: String
  column: String
  paragraph: String
  matchStatus: CitationMatchStatus!
  confidence: Float
}

input CreateLessonInput {
  courseId: ID!
  moduleId: ID
  title: String!
  type: LessonType!
  series: String
  lessonDate: String
  instructorId: ID!
}

input UpdateLessonInput {
  title: String
  type: LessonType
  series: String
  lessonDate: String
  status: LessonStatus
}

input AddLessonAssetInput {
  assetType: LessonAssetType!
  sourceUrl: String
  fileUrl: String
  mediaAssetId: ID
  metadata: JSON
}

input SaveLessonPipelineInput {
  templateName: String
  nodes: JSON!
  config: JSON
}

extend type Query {
  lesson(id: ID!): Lesson @authenticated
  lessonsByCourse(courseId: ID!, limit: Int = 20, offset: Int = 0): [Lesson!]! @authenticated
  lessonPipelineRun(runId: ID!): LessonPipelineRun @authenticated
}

extend type Mutation {
  createLesson(input: CreateLessonInput!): Lesson!
    @authenticated
    @requiresScopes(scopes: ["course:write"])
  updateLesson(id: ID!, input: UpdateLessonInput!): Lesson!
    @authenticated
    @requiresScopes(scopes: ["course:write"])
  deleteLesson(id: ID!): Boolean!
    @authenticated
    @requiresScopes(scopes: ["course:write"])
  addLessonAsset(lessonId: ID!, input: AddLessonAssetInput!): LessonAsset!
    @authenticated
    @requiresScopes(scopes: ["course:write"])
  saveLessonPipeline(lessonId: ID!, input: SaveLessonPipelineInput!): LessonPipeline!
    @authenticated
    @requiresScopes(scopes: ["course:write"])
  startLessonPipelineRun(pipelineId: ID!): LessonPipelineRun!
    @authenticated
    @requiresScopes(scopes: ["course:write"])
  cancelLessonPipelineRun(runId: ID!): LessonPipelineRun!
    @authenticated
    @requiresScopes(scopes: ["course:write"])
  publishLesson(id: ID!): Lesson!
    @authenticated
    @requiresScopes(scopes: ["course:write"])
}

extend type Subscription {
  lessonPipelineProgress(runId: ID!): LessonPipelineRun! @authenticated
}
