extend schema
  @link(url: "https://specs.apollo.dev/federation/v2.7", import: ["@key", "@authenticated"])

type Concept @key(fields: "id") {
  id: ID!
  tenantId: ID!
  name: String!
  definition: String!
  sourceIds: [ID!]!
  createdAt: String!
  updatedAt: String!
}

type Person @key(fields: "id") {
  id: ID!
  tenantId: ID!
  name: String!
  bio: String
  createdAt: String!
  updatedAt: String!
}

type Term @key(fields: "id") {
  id: ID!
  tenantId: ID!
  name: String!
  definition: String!
  createdAt: String!
  updatedAt: String!
}

type Source @key(fields: "id") {
  id: ID!
  tenantId: ID!
  title: String!
  type: String!
  url: String
  createdAt: String!
  updatedAt: String!
}

type TopicCluster @key(fields: "id") {
  id: ID!
  tenantId: ID!
  name: String!
  description: String
  createdAt: String!
  updatedAt: String!
}

type ConceptRelationship {
  fromConcept: Concept!
  toConcept: Concept!
  relationshipType: String!
  strength: Float
  inferred: Boolean
  description: String
}

type RelatedConcept {
  concept: Concept!
  strength: Float!
}

type Course @key(fields: "id") {
  id: ID!
}

type ContentItem @key(fields: "id") {
  id: ID!
}

extend type Query {
  concept(id: ID!): Concept
  conceptByName(name: String!): Concept
  concepts(limit: Int = 20): [Concept!]!
  relatedConcepts(conceptId: ID!, depth: Int = 2, limit: Int = 10): [RelatedConcept!]!

  person(id: ID!): Person
  personByName(name: String!): Person

  term(id: ID!): Term
  termByName(name: String!): Term

  source(id: ID!): Source

  topicCluster(id: ID!): TopicCluster
  topicClustersByCourse(courseId: ID!): [TopicCluster!]!

  searchSemantic(query: String!, limit: Int = 10): [SemanticResult!]!

  """
  Find the shortest learning path between two concepts identified by name.
  Returns null when no path exists between the two concepts.
  Uses Apache AGE shortestPath() traversing RELATED_TO and PREREQUISITE_OF edges.
  """
  learningPath(from: String!, to: String!): LearningPath @authenticated

  """
  Collect all distinct concepts reachable from a named concept within `depth` hops
  (default depth 2, max 5) via RELATED_TO edges using COLLECT(DISTINCT ...) aggregation.
  """
  relatedConceptsByName(conceptName: String!, depth: Int = 2): [ConceptNode!]! @authenticated

  """
  Find the deepest prerequisite chain leading into a named concept.
  Returns nodes ordered from root prerequisite to the target concept.
  """
  prerequisiteChain(conceptName: String!): [ConceptNode!]! @authenticated
}

extend type Mutation {
  createConcept(input: CreateConceptInput!): Concept! @authenticated
  updateConcept(id: ID!, input: UpdateConceptInput!): Concept! @authenticated
  deleteConcept(id: ID!): Boolean! @authenticated

  linkConcepts(fromId: ID!, toId: ID!, relationshipType: String!, strength: Float, description: String): ConceptRelationship! @authenticated

  createPerson(input: CreatePersonInput!): Person! @authenticated
  createTerm(input: CreateTermInput!): Term! @authenticated
  createSource(input: CreateSourceInput!): Source! @authenticated
  createTopicCluster(input: CreateTopicClusterInput!): TopicCluster! @authenticated

  generateEmbedding(text: String!, entityType: String!, entityId: ID!): Boolean! @authenticated
}

input CreateConceptInput {
  name: String!
  definition: String!
  sourceIds: [ID!]
}

input UpdateConceptInput {
  name: String
  definition: String
  sourceIds: [ID!]
}

input CreatePersonInput {
  name: String!
  bio: String
}

input CreateTermInput {
  name: String!
  definition: String!
}

input CreateSourceInput {
  title: String!
  type: String!
  url: String
}

input CreateTopicClusterInput {
  name: String!
  description: String
}

type SemanticResult {
  id: ID!
  text: String!
  similarity: Float!
  entityType: String!
  entityId: ID!
}

"""
A lightweight concept node used in learning path and prerequisite chain results.
Distinct from the full Concept entity — carries only the fields needed for path display.
"""
type ConceptNode {
  id: ID!
  name: String!
  type: String
}

"""
Result of a shortestPath query between two concepts.
concepts: ordered list of ConceptNodes along the path (start inclusive, end inclusive).
steps: number of edges in the path (= length of path).
"""
type LearningPath {
  concepts: [ConceptNode!]!
  steps: Int!
}

# ─── F-006: Skill Gap Analysis ───────────────────────────────────────────────

"""
A single concept gap item: whether it is mastered and what content is recommended.
"""
type SkillGapItem {
  conceptName: String!
  isMastered: Boolean!
  recommendedContentItems: [ID!]!
  recommendedContentTitles: [String!]!
  relevanceScore: Float!
}

"""
Full skill gap report comparing a learner's mastery against a role profile.
"""
type SkillGapReport {
  roleId: ID!
  roleName: String!
  totalRequired: Int!
  mastered: Int!
  gapCount: Int!
  completionPercentage: Float!
  gaps: [SkillGapItem!]!
}

"""
A brief view of a skill profile (role/goal definition).
"""
type SkillProfile {
  id: ID!
  roleName: String!
  description: String
  requiredConceptsCount: Int!
}

extend type Query {
  """
  Analyze skill gap between the current user's mastery and a named skill profile.
  """
  skillGapAnalysis(roleId: ID!): SkillGapReport! @authenticated

  """
  List all skill profiles available within the current tenant.
  """
  skillProfiles: [SkillProfile!]! @authenticated
}

extend type Mutation {
  """
  Create a new skill profile defining required concepts for a role/goal.
  Only instructors and admins may create profiles.
  """
  createSkillProfile(
    roleName: String!
    description: String
    requiredConcepts: [String!]!
  ): SkillProfile! @authenticated
}

# ─── F-002: Personalized Auto Learning Path ──────────────────────────────────

"""
A single node in the personalized learning path (concept + completion status).
"""
type AutoPathNode {
  conceptName: String!
  isCompleted: Boolean!
  contentItems: [String!]!
}

"""
Personalized learning path toward a target concept, showing per-node completion.
"""
type AutoPath {
  targetConceptName: String!
  nodes: [AutoPathNode!]!
  totalSteps: Int!
  completedSteps: Int!
}

extend type Query {
  """
  Return a personalized learning path toward the named concept.
  Nodes are ordered from prerequisite to target; isCompleted reflects user progress.
  """
  myLearningPath(targetConceptName: String!): AutoPath @authenticated
}
