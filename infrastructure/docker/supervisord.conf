[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

# ═══════════════════════════════════════════════════════════════
# PostgreSQL
# ═══════════════════════════════════════════════════════════════
[program:postgresql]
user=postgres
command=/usr/lib/postgresql/17/bin/postgres -D /var/lib/postgresql/17/main -c config_file=/etc/postgresql/17/main/postgresql.conf
autostart=true
autorestart=true
priority=10
stdout_logfile=/var/log/postgresql/postgresql.log
stderr_logfile=/var/log/postgresql/postgresql-error.log

# ═══════════════════════════════════════════════════════════════
# Redis
# ═══════════════════════════════════════════════════════════════
[program:redis]
command=/usr/bin/redis-server --requirepass edusphere_redis_password --bind 0.0.0.0
autostart=true
autorestart=true
priority=20
stdout_logfile=/var/log/redis/redis.log
stderr_logfile=/var/log/redis/redis-error.log

# ═══════════════════════════════════════════════════════════════
# NATS JetStream
# ═══════════════════════════════════════════════════════════════
[program:nats]
command=/usr/local/bin/nats-server -js -m 8222 --user edusphere --pass edusphere_nats_password
autostart=true
autorestart=true
priority=30
stdout_logfile=/var/log/nats/nats.log
stderr_logfile=/var/log/nats/nats-error.log

# ═══════════════════════════════════════════════════════════════
# MinIO
# ═══════════════════════════════════════════════════════════════
[program:minio]
command=/usr/local/bin/minio server /data/minio --console-address ":9001"
environment=MINIO_ROOT_USER="minioadmin",MINIO_ROOT_PASSWORD="minioadmin"
autostart=true
autorestart=true
priority=40
stdout_logfile=/var/log/minio/minio.log
stderr_logfile=/var/log/minio/minio-error.log

# ═══════════════════════════════════════════════════════════════
# Keycloak (wait for PostgreSQL)
# ═══════════════════════════════════════════════════════════════
[program:keycloak]
command=/opt/keycloak/bin/kc.sh start-dev --import-realm
environment=KEYCLOAK_ADMIN="admin",KEYCLOAK_ADMIN_PASSWORD="admin",KC_DB="postgres",KC_DB_URL="jdbc:postgresql://localhost:5432/keycloak",KC_DB_USERNAME="edusphere",KC_DB_PASSWORD="edusphere_dev_password",KC_HOSTNAME="localhost",KC_HTTP_ENABLED="true"
autostart=true
autorestart=true
priority=50
startsecs=30
stdout_logfile=/var/log/keycloak/keycloak.log
stderr_logfile=/var/log/keycloak/keycloak-error.log

# ═══════════════════════════════════════════════════════════════
# Keycloak password seed (one-shot, runs after Keycloak is ready)
# Resets demo-user passwords on every startup so they always match
# the documented credentials regardless of realm-import state.
# ═══════════════════════════════════════════════════════════════
[program:keycloak-seed-passwords]
command=/bin/bash -c 'sleep 45 && node /app/scripts/reset-keycloak-passwords.cjs && echo "Keycloak passwords seeded"'
environment=PATH="/opt/nodejs/bin:%(ENV_PATH)s"
autostart=true
autorestart=false
priority=55
startsecs=0
stdout_logfile=/var/log/keycloak/seed-passwords.log
stderr_logfile=/var/log/keycloak/seed-passwords-error.log

# ═══════════════════════════════════════════════════════════════
# Ollama
# ═══════════════════════════════════════════════════════════════
[program:ollama]
command=ollama serve
autostart=false
autorestart=false
priority=60
stdout_logfile=/var/log/ollama/ollama.log
stderr_logfile=/var/log/ollama/ollama-error.log

# ═══════════════════════════════════════════════════════════════
# GraphQL Gateway (wait for all infrastructure)
# ═══════════════════════════════════════════════════════════════
[program:gateway]
directory=/app/apps/gateway
command=/app/apps/gateway/node_modules/.bin/hive-gateway supergraph --config-path gateway.config.ts --host 0.0.0.0
environment=PORT="4000",PATH="/opt/nodejs/bin:%(ENV_PATH)s"
autostart=true
autorestart=true
priority=100
startsecs=10
stdout_logfile=/var/log/edusphere/gateway.log
stderr_logfile=/var/log/edusphere/gateway-error.log

# ═══════════════════════════════════════════════════════════════
# Core Subgraph
# ═══════════════════════════════════════════════════════════════
[program:subgraph-core]
directory=/app/apps/subgraph-core
command=node dist/main
environment=PORT="4001",DATABASE_URL="postgresql://edusphere:edusphere_dev_password@localhost:5432/edusphere",PATH="/opt/nodejs/bin:%(ENV_PATH)s"
autostart=true
autorestart=true
priority=110
startsecs=10
stdout_logfile=/var/log/edusphere/subgraph-core.log
stderr_logfile=/var/log/edusphere/subgraph-core-error.log

# ═══════════════════════════════════════════════════════════════
# Content Subgraph (Port 4002)
# ═══════════════════════════════════════════════════════════════
[program:subgraph-content]
directory=/app/apps/subgraph-content
command=node dist/main
environment=PORT="4002",DATABASE_URL="postgresql://edusphere:edusphere_dev_password@localhost:5432/edusphere",PATH="/opt/nodejs/bin:%(ENV_PATH)s"
autostart=true
autorestart=true
priority=111
startsecs=10
stdout_logfile=/var/log/edusphere/subgraph-content.log
stderr_logfile=/var/log/edusphere/subgraph-content-error.log

# ═══════════════════════════════════════════════════════════════
# Annotation Subgraph (Port 4003)
# ═══════════════════════════════════════════════════════════════
[program:subgraph-annotation]
directory=/app/apps/subgraph-annotation
command=node dist/main
environment=PORT="4003",DATABASE_URL="postgresql://edusphere:edusphere_dev_password@localhost:5432/edusphere",PATH="/opt/nodejs/bin:%(ENV_PATH)s"
autostart=true
autorestart=true
priority=112
startsecs=10
stdout_logfile=/var/log/edusphere/subgraph-annotation.log
stderr_logfile=/var/log/edusphere/subgraph-annotation-error.log

# ═══════════════════════════════════════════════════════════════
# Collaboration Subgraph (Port 4004)
# ═══════════════════════════════════════════════════════════════
[program:subgraph-collaboration]
directory=/app/apps/subgraph-collaboration
command=node dist/main
environment=PORT="4004",DATABASE_URL="postgresql://edusphere:edusphere_dev_password@localhost:5432/edusphere",PATH="/opt/nodejs/bin:%(ENV_PATH)s"
autostart=true
autorestart=true
priority=113
startsecs=10
stdout_logfile=/var/log/edusphere/subgraph-collaboration.log
stderr_logfile=/var/log/edusphere/subgraph-collaboration-error.log

# ═══════════════════════════════════════════════════════════════
# Agent Subgraph (Port 4005)
# ═══════════════════════════════════════════════════════════════
[program:subgraph-agent]
directory=/app/apps/subgraph-agent
command=node dist/main
environment=PORT="4005",DATABASE_URL="postgresql://edusphere:edusphere_dev_password@localhost:5432/edusphere",PATH="/opt/nodejs/bin:%(ENV_PATH)s"
autostart=true
autorestart=true
priority=114
startsecs=10
stdout_logfile=/var/log/edusphere/subgraph-agent.log
stderr_logfile=/var/log/edusphere/subgraph-agent-error.log

# ═══════════════════════════════════════════════════════════════
# Knowledge Subgraph (Port 4006) - pgvector + Semantic Search
# ═══════════════════════════════════════════════════════════════
[program:subgraph-knowledge]
directory=/app/apps/subgraph-knowledge
command=node dist/main
environment=PORT="4006",DATABASE_URL="postgresql://edusphere:edusphere_dev_password@localhost:5432/edusphere",PATH="/opt/nodejs/bin:%(ENV_PATH)s"
autostart=true
autorestart=true
priority=115
startsecs=10
stdout_logfile=/var/log/edusphere/subgraph-knowledge.log
stderr_logfile=/var/log/edusphere/subgraph-knowledge-error.log

# ═══════════════════════════════════════════════════════════════
# Compose Supergraph (one-shot after all subgraphs are ready)
# ═══════════════════════════════════════════════════════════════
[program:compose-supergraph]
command=/bin/bash -c 'sleep 35 && cd /app/apps/gateway && node compose.js && echo "Supergraph composed successfully"'
environment=PATH="/opt/nodejs/bin:%(ENV_PATH)s"
autostart=true
autorestart=false
priority=200
startsecs=0
stdout_logfile=/var/log/edusphere/compose-supergraph.log
stderr_logfile=/var/log/edusphere/compose-supergraph-error.log
