[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid

# ═══════════════════════════════════════════════════════════════
# PostgreSQL
# ═══════════════════════════════════════════════════════════════
[program:postgresql]
user=postgres
command=/usr/lib/postgresql/16/bin/postgres -D /var/lib/postgresql/16/main -c config_file=/etc/postgresql/16/main/postgresql.conf
autostart=true
autorestart=true
priority=10
stdout_logfile=/var/log/postgresql/postgresql.log
stderr_logfile=/var/log/postgresql/postgresql-error.log

# ═══════════════════════════════════════════════════════════════
# Redis
# ═══════════════════════════════════════════════════════════════
[program:redis]
command=/usr/bin/redis-server --requirepass edusphere_redis_password --bind 0.0.0.0
autostart=true
autorestart=true
priority=20
stdout_logfile=/var/log/redis/redis.log
stderr_logfile=/var/log/redis/redis-error.log

# ═══════════════════════════════════════════════════════════════
# NATS JetStream
# ═══════════════════════════════════════════════════════════════
[program:nats]
command=/usr/local/bin/nats-server -js -m 8222 --user edusphere --pass edusphere_nats_password
autostart=true
autorestart=true
priority=30
stdout_logfile=/var/log/nats/nats.log
stderr_logfile=/var/log/nats/nats-error.log

# ═══════════════════════════════════════════════════════════════
# MinIO
# ═══════════════════════════════════════════════════════════════
[program:minio]
command=/usr/local/bin/minio server /data/minio --console-address ":9001"
environment=MINIO_ROOT_USER="minioadmin",MINIO_ROOT_PASSWORD="minioadmin"
autostart=true
autorestart=true
priority=40
stdout_logfile=/var/log/minio/minio.log
stderr_logfile=/var/log/minio/minio-error.log

# ═══════════════════════════════════════════════════════════════
# Keycloak (wait for PostgreSQL)
# ═══════════════════════════════════════════════════════════════
[program:keycloak]
command=/opt/keycloak/bin/kc.sh start-dev --import-realm
environment=KEYCLOAK_ADMIN="admin",KEYCLOAK_ADMIN_PASSWORD="admin",KC_DB="postgres",KC_DB_URL="jdbc:postgresql://localhost:5432/keycloak",KC_DB_USERNAME="edusphere",KC_DB_PASSWORD="edusphere_dev_password",KC_HOSTNAME="localhost",KC_HTTP_ENABLED="true"
autostart=true
autorestart=true
priority=50
startsecs=30
stdout_logfile=/var/log/keycloak/keycloak.log
stderr_logfile=/var/log/keycloak/keycloak-error.log

# ═══════════════════════════════════════════════════════════════
# Ollama
# ═══════════════════════════════════════════════════════════════
[program:ollama]
command=ollama serve
autostart=true
autorestart=true
priority=60
stdout_logfile=/var/log/ollama/ollama.log
stderr_logfile=/var/log/ollama/ollama-error.log

# ═══════════════════════════════════════════════════════════════
# GraphQL Gateway (wait for all infrastructure)
# ═══════════════════════════════════════════════════════════════
[program:gateway]
directory=/app/apps/gateway
command=pnpm dev
autostart=true
autorestart=true
priority=100
startsecs=10
stdout_logfile=/var/log/edusphere/gateway.log
stderr_logfile=/var/log/edusphere/gateway-error.log

# ═══════════════════════════════════════════════════════════════
# Core Subgraph
# ═══════════════════════════════════════════════════════════════
[program:subgraph-core]
directory=/app/apps/subgraph-core
command=pnpm dev
environment=PORT="4001",DATABASE_URL="postgresql://edusphere:edusphere_dev_password@localhost:5432/edusphere"
autostart=true
autorestart=true
priority=110
startsecs=10
stdout_logfile=/var/log/edusphere/subgraph-core.log
stderr_logfile=/var/log/edusphere/subgraph-core-error.log

# ═══════════════════════════════════════════════════════════════
# Additional subgraphs will be added here as they are developed
# ═══════════════════════════════════════════════════════════════
