# =============================================================================
# EduSphere — Staging Helm Values
#
# Overrides values.yaml for the staging environment.
# Lower replica counts and resource limits than production to reduce cost,
# while still exercising the full deployment topology.
# =============================================================================

global:
  namespace: edusphere-staging

# ── Replica counts (lean for staging) ────────────────────────────────────────
replicaCount:
  gateway: 1
  subgraph: 1
  frontend: 1

# ── Image — tag is injected by the CD pipeline at deploy time ─────────────────
# pullPolicy: Always in staging ensures the latest tag is guaranteed to be pulled
# even when the tag name (e.g. 'main-abc1234') was previously cached on a node.
image:
  registry: ghcr.io
  repository: edusphere-org/edusphere
  pullPolicy: Always
  tag: '' # Set by CD: --set image.tag=main-<sha>

# ── Gateway ───────────────────────────────────────────────────────────────────
gateway:
  enabled: true
  autoscaling:
    enabled: false # No HPA in staging — predictable load
    minReplicas: 1
    maxReplicas: 3
  podDisruptionBudget:
    minAvailable: 1
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  env:
    NODE_ENV: staging
    LOG_LEVEL: debug

# ── Subgraphs ─────────────────────────────────────────────────────────────────
subgraphs:
  core:
    enabled: true
    port: 4001
    replicas: 1
    env:
      NODE_ENV: staging
      LOG_LEVEL: debug
  content:
    enabled: true
    port: 4002
    replicas: 1
    env:
      NODE_ENV: staging
      LOG_LEVEL: debug
  annotation:
    enabled: true
    port: 4003
    replicas: 1
    env:
      NODE_ENV: staging
      LOG_LEVEL: debug
  collaboration:
    enabled: true
    port: 4004
    replicas: 1
    env:
      NODE_ENV: staging
      LOG_LEVEL: debug
  agent:
    enabled: true
    port: 4005
    replicas: 1
    resources:
      requests:
        cpu: 250m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 2Gi
    env:
      NODE_ENV: staging
      LOG_LEVEL: debug
  knowledge:
    enabled: true
    port: 4006
    replicas: 1
    env:
      NODE_ENV: staging
      LOG_LEVEL: debug

# ── Frontend ──────────────────────────────────────────────────────────────────
frontend:
  enabled: true
  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 2
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 250m
      memory: 256Mi
  env:
    NODE_ENV: staging

# ── Ingress ───────────────────────────────────────────────────────────────────
ingress:
  enabled: true
  className: traefik
  host: staging.edusphere.dev
  apiHost: staging-api.edusphere.dev
  tls:
    enabled: true
    secretName: edusphere-staging-tls
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-staging
    traefik.ingress.kubernetes.io/router.tls: 'true'

# ── External services — shared staging cluster ────────────────────────────────
# Staging uses a shared PostgreSQL and Redis instance (not bundled via Helm).
# Connection strings are pulled from the 'edusphere-staging-secrets' Secret
# managed by External Secrets Operator.
postgresql:
  enabled: false # Use shared staging PostgreSQL instance (external)

redis:
  enabled: false # Use shared staging Redis instance (external)

# ── Pod security (same as production) ────────────────────────────────────────
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1001
  fsGroup: 1001

securityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  capabilities:
    drop:
      - ALL

# ── Service account ───────────────────────────────────────────────────────────
serviceAccount:
  create: true
  name: 'edusphere-staging'

# ── Observability ─────────────────────────────────────────────────────────────
monitoring:
  # Prometheus scraping annotations are set in pod templates
  enabled: true
  namespace: monitoring
