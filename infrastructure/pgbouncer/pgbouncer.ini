; ============================================================
; EduSphere PgBouncer Configuration
; Mode: transaction pooling (optimal for NestJS + Drizzle ORM)
; ============================================================
;
; Architecture notes
; ------------------
; 6 NestJS subgraphs × 25 server connections each = 150 server connections max.
; PostgreSQL max_connections must be set to at least 200 (with headroom).
; PgBouncer client-side connections: up to 1000 (much higher than server-side).
;
; Transaction pooling is mandatory when using:
;   - SET LOCAL (RLS tenant context) — queries inside explicit BEGIN/COMMIT blocks
;   - Drizzle ORM transactions
;   - LISTEN/NOTIFY (use session pooling for those specific connections instead)
;
; For NATS-to-PostgreSQL listener connections, use a separate pgbouncer pool
; with pool_mode = session, or connect directly to PostgreSQL.

[databases]
; Each subgraph has its own named pool entry so pool sizes can be tuned.
; Format: <pool-name> = host=<pg-host> port=<pg-port> dbname=<dbname>

; Core subgraph (users, tenants, roles)
edusphere_core = host=postgres port=5432 dbname=edusphere
    pool_size=25

; Content subgraph (courses, lessons, media)
edusphere_content = host=postgres port=5432 dbname=edusphere
    pool_size=25

; Annotation subgraph (highlights, comments, personal notes)
edusphere_annotation = host=postgres port=5432 dbname=edusphere
    pool_size=25

; Collaboration subgraph (rooms, presence, chat)
edusphere_collaboration = host=postgres port=5432 dbname=edusphere
    pool_size=25

; Agent subgraph (LangGraph workflows, AI sessions) — larger pool for long queries
edusphere_agent = host=postgres port=5432 dbname=edusphere
    pool_size=35

; Knowledge subgraph (pgvector, Apache AGE graph) — larger pool for vector queries
edusphere_knowledge = host=postgres port=5432 dbname=edusphere
    pool_size=35

; Catch-all default pool (migrations, admin, health checks)
edusphere = host=postgres port=5432 dbname=edusphere
    pool_size=10

[pgbouncer]
; ─── Networking ─────────────────────────────────────────────
listen_addr = 0.0.0.0
listen_port = 5432
unix_socket_dir =

; ─── Pooling mode ───────────────────────────────────────────
; transaction = server connection released after each transaction
; Required for NestJS Drizzle ORM with SET LOCAL RLS context
pool_mode = transaction

; ─── Connection limits ──────────────────────────────────────
; Maximum client connections (across all pools)
max_client_conn = 1000

; Default pool_size when not specified per-database above
default_pool_size = 20

; Reserve pool: extra connections available for slow clients
reserve_pool_size = 5

; Connections added to reserve pool after this many seconds waiting
reserve_pool_timeout = 3

; Max connections per database (0 = unlimited, rely on pool_size)
max_db_connections = 200

; Max connections per user (0 = unlimited)
max_user_connections = 0

; ─── Timeouts ───────────────────────────────────────────────
; Close idle server connections after N seconds
server_idle_timeout = 600

; Abandon connection attempt if server does not respond within N seconds
server_connect_timeout = 15

; Lifetime of server connection (forces reconnect, useful for cred rotation)
server_lifetime = 3600

; Drop client if it has not sent a query within N seconds (0 = disabled)
client_idle_timeout = 0

; Abort client queries that run longer than N seconds (0 = disabled)
; Set generously to allow complex pgvector / AGE graph queries
query_timeout = 300

; ─── Authentication ─────────────────────────────────────────
; auth_type options: md5, scram-sha-256, trust, cert
; Use scram-sha-256 for PostgreSQL 16 (preferred)
auth_type = scram-sha-256
auth_file = /etc/pgbouncer/userlist.txt

; ─── Logging ────────────────────────────────────────────────
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
; Verbose stats log interval (seconds). Set 0 to disable.
stats_period = 60

; ─── TLS (enable in production) ─────────────────────────────
; client_tls_sslmode = require
; client_tls_ca_file = /etc/ssl/certs/ca.crt
; client_tls_cert_file = /etc/ssl/certs/pgbouncer.crt
; client_tls_key_file = /etc/ssl/private/pgbouncer.key
; server_tls_sslmode = require

; ─── Admin console ──────────────────────────────────────────
; Connect to virtual database "pgbouncer" to view stats:
;   psql -h 127.0.0.1 -p 5432 -U pgbouncer pgbouncer
admin_users = pgbouncer_admin
stats_users = pgbouncer_stats

; ─── Feature flags ──────────────────────────────────────────
; Automatically handle SET commands from clients (needed for RLS SET LOCAL)
; In transaction mode, SET issued outside a transaction is handled by PgBouncer
; and does NOT propagate to server connection. Use BEGIN/SET LOCAL/COMMIT instead.
ignore_startup_parameters = extra_float_digits,options
