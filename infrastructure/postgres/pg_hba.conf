# =============================================================================
# PostgreSQL Host-Based Authentication (pg_hba.conf)
# EduSphere Platform — PostgreSQL 16
# =============================================================================
# Auth method policy:
#   - scram-sha-256 ONLY for all connections
#   - NO md5 (deprecated, vulnerable to offline dictionary attacks)
#   - NO trust (bypasses authentication — never in production)
#   - NO peer (only for local OS user match, disabled for app users)
# =============================================================================
# Format: TYPE  DATABASE        USER            ADDRESS                 METHOD
# =============================================================================

# -----------------------------------------------------------------------------
# Local connections (Unix domain socket) — for superuser maintenance only
# Limit to postgres OS user via peer; all app connections use TCP.
# -----------------------------------------------------------------------------
local   all             postgres                                peer

# Disallow local socket connections for all other users (force TCP + auth).
local   all             all                                     reject

# -----------------------------------------------------------------------------
# Replication connections — Streaming replication from replica nodes
# The 'replicator' role must be created on the primary:
#   CREATE ROLE replicator WITH REPLICATION LOGIN PASSWORD '<secret>';
#
# ADDRESS: 10.0.1.0/24 — replace with your actual replica subnet CIDR.
# Use a dedicated subnet isolated from application traffic.
# -----------------------------------------------------------------------------
host    replication     replicator      10.0.1.0/24             scram-sha-256

# Allow pg_basebackup from ops/admin subnet for initial replica provisioning.
# Restrict to bastion/CI CIDR — tighten before production.
host    replication     replicator      10.0.0.0/24             scram-sha-256

# -----------------------------------------------------------------------------
# Application connections — EduSphere subgraphs
# Each subgraph connects as the 'edusphere_app' role.
# Roles must be created: CREATE ROLE edusphere_app LOGIN PASSWORD '<secret>';
# ADDRESS: 10.0.2.0/24 — replace with actual app subnet CIDR.
# -----------------------------------------------------------------------------

# Primary database — writes + reads from NestJS subgraphs
host    edusphere_db    edusphere_app   10.0.2.0/24             scram-sha-256

# Replica database — read-only connections from read replica helper
host    edusphere_db    edusphere_app   10.0.1.0/24             scram-sha-256

# PgBouncer connection pooler — pooler connects as edusphere_app
host    edusphere_db    edusphere_app   127.0.0.1/32            scram-sha-256

# -----------------------------------------------------------------------------
# Monitoring connections — Prometheus postgres_exporter
# Restricted to monitoring subnet; read-only pg_monitor role.
# CREATE ROLE edusphere_monitor WITH LOGIN IN ROLE pg_monitor PASSWORD '<secret>';
# -----------------------------------------------------------------------------
host    postgres        edusphere_monitor   10.0.3.0/24         scram-sha-256

# -----------------------------------------------------------------------------
# Administration connections — DBA access from bastion host only
# Restrict SOURCE_IP to bastion/VPN egress IP in production.
# -----------------------------------------------------------------------------
host    all             postgres        10.0.0.10/32            scram-sha-256

# -----------------------------------------------------------------------------
# Deny all other connections (fail-closed default)
# This catch-all must be last — pg_hba.conf is evaluated top-to-bottom.
# -----------------------------------------------------------------------------
host    all             all             0.0.0.0/0               reject
host    all             all             ::/0                    reject
