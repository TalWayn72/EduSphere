version: "3.9"

services:
  # ═══════════════════════════════════════════════════════════════
  # EduSphere - All-in-One Container
  # Single container with all services and subgraphs
  # ═══════════════════════════════════════════════════════════════
  edusphere:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: edusphere-all-in-one
    image: edusphere:latest
    ports:
      # GraphQL Gateway + Subgraphs
      - "4000:4000" # Gateway
      - "4001:4001" # Core Subgraph
      - "4002:4002" # Content Subgraph (future)
      - "4003:4003" # Annotation Subgraph (future)
      - "4004:4004" # Collaboration Subgraph (future)
      - "4005:4005" # Agent Subgraph (future)
      - "4006:4006" # Knowledge Subgraph (future)
      # Infrastructure
      - "5432:5432" # PostgreSQL
      - "6379:6379" # Redis
      - "8080:8080" # Keycloak
      - "4222:4222" # NATS Client
      - "8222:8222" # NATS Monitoring
      - "9000:9000" # MinIO API
      - "9001:9001" # MinIO Console
      - "11434:11434" # Ollama
    volumes:
      # Persist data outside container
      - postgres_data:/var/lib/postgresql/17/main
      - keycloak_data:/opt/keycloak/data
      - minio_data:/data/minio
      - ollama_data:/root/.ollama
      # Persist mcp-nats installation for Claude Code MCP server
      - nats_mcp_data:/tmp/nats-test
      # Optional: Mount code for development hot-reload
      # - ./apps:/app/apps
      # - ./packages:/app/packages
    environment:
      # Node
      - NODE_ENV=development
      # Memory safety: cap Node.js heap to 6 GiB inside the 8 GiB container limit
      - NODE_OPTIONS=--max-old-space-size=6144
      # Database
      # G-07: DB SSL Mode — dev uses sslmode=prefer; production requires sslmode=require
      # Production: DATABASE_URL=...@host:5432/edusphere?sslmode=require
      - DATABASE_URL=postgresql://edusphere:edusphere_dev_password@localhost:5432/edusphere?sslmode=prefer
      # G-17: MinIO Server-Side Encryption (SSE-S3 / AES-256)
      # Format: "key-name:base64-32-byte-secret" — use vault-managed secret in production
      - MINIO_KMS_SECRET_KEY=edusphere-encryption-key:${MINIO_ENCRYPTION_KEY:-CHANGE_ME_REPLACE_WITH_32_CHAR_MIN_KEY!}
      # G-16: NATS TLS — set NATS_TLS_CERT/KEY/CA env vars in .env for mTLS in production
      # Dev default: plain-text NATS (no TLS); all three vars must be set for production mTLS
      # CORS
      - CORS_ORIGIN=http://localhost:5173,http://localhost:3000
      # Logging
      - LOG_LEVEL=debug
      - LOG_PRETTY=true
    # ── Memory Safety (Wave 4-B) ──────────────────────────────────
    # Hard limit: Docker OOM-killer fires at 8 GiB.
    # Soft reservation: scheduler keeps 4 GiB guaranteed for this
    # container; NODE_OPTIONS above caps the JS heap at 6 GiB so
    # the process can be killed cleanly before the hard limit.
    mem_limit: 8g
    mem_reservation: 4g
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    restart: unless-stopped

volumes:
  postgres_data:
  keycloak_data:
  minio_data:
  ollama_data:
  nats_mcp_data:
