version: '3.9'

services:
  # ═══════════════════════════════════════════════════════════════
  # EduSphere - All-in-One Container
  # Single container with all services and subgraphs
  # ═══════════════════════════════════════════════════════════════
  edusphere:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: edusphere-all-in-one
    image: edusphere:latest
    ports:
      # GraphQL Gateway + Subgraphs
      - "4000:4000"   # Gateway
      - "4001:4001"   # Core Subgraph
      - "4002:4002"   # Content Subgraph (future)
      - "4003:4003"   # Annotation Subgraph (future)
      - "4004:4004"   # Collaboration Subgraph (future)
      - "4005:4005"   # Agent Subgraph (future)
      - "4006:4006"   # Knowledge Subgraph (future)
      # Infrastructure
      - "5432:5432"   # PostgreSQL
      - "6379:6379"   # Redis
      - "8080:8080"   # Keycloak
      - "4222:4222"   # NATS Client
      - "8222:8222"   # NATS Monitoring
      - "9000:9000"   # MinIO API
      - "9001:9001"   # MinIO Console
      - "11434:11434" # Ollama
    volumes:
      # Persist data outside container
      - postgres_data:/var/lib/postgresql/16/main
      - keycloak_data:/opt/keycloak/data
      - minio_data:/data/minio
      - ollama_data:/root/.ollama
      # Optional: Mount code for development hot-reload
      # - ./apps:/app/apps
      # - ./packages:/app/packages
    environment:
      # Node
      - NODE_ENV=development
      # Database
      - DATABASE_URL=postgresql://edusphere:edusphere_dev_password@localhost:5432/edusphere
      # CORS
      - CORS_ORIGIN=http://localhost:5173,http://localhost:3000
      # Logging
      - LOG_LEVEL=debug
      - LOG_PRETTY=true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    restart: unless-stopped

volumes:
  postgres_data:
  keycloak_data:
  minio_data:
  ollama_data:
