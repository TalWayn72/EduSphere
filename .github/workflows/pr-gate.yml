name: PR Quality Gate

# Only trigger on pull requests to main/master/develop
on:
  pull_request:
    branches:
      - main
      - master
      - develop
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review

# Cancel outdated runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # PR validation - basic checks
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # Skip draft PRs
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate PR title
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          # Check PR title follows conventional commits format
          # Allowed types: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert
          if ! echo "$PR_TITLE" | grep -qE '^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .+'; then
            echo "âŒ PR title does not follow Conventional Commits format"
            echo "Expected format: type(scope): description"
            echo "Examples:"
            echo "  - feat(auth): add JWT validation"
            echo "  - fix(api): resolve CORS issue"
            echo "  - docs(readme): update installation steps"
            exit 1
          fi

          echo "âœ… PR title follows Conventional Commits format"

      - name: Check PR description
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          if [ -z "$PR_BODY" ]; then
            echo "âš ï¸ PR description is empty. Please add a description."
            exit 1
          fi

          echo "âœ… PR has a description"

      - name: Validate branch naming
        run: |
          BRANCH_NAME="${{ github.head_ref }}"

          # Allowed patterns: feature/*, fix/*, hotfix/*, release/*, docs/*
          if ! echo "$BRANCH_NAME" | grep -qE '^(feature|fix|hotfix|release|docs|chore|refactor)/'; then
            echo "âš ï¸ Branch name does not follow naming convention"
            echo "Expected: feature/*, fix/*, hotfix/*, release/*, docs/*, chore/*, refactor/*"
            echo "Actual: $BRANCH_NAME"
          else
            echo "âœ… Branch name follows convention"
          fi

      - name: Check for merge conflicts
        run: |
          # This check is handled by GitHub automatically
          echo "âœ… No merge conflicts detected"

  # Wait for all CI checks to complete
  wait-for-ci:
    name: Wait for CI Checks
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: pr-validation

    steps:
      - name: Wait for CI workflow
        uses: fountainhead/action-wait-for-check@v1.2.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: CI Complete
          ref: ${{ github.event.pull_request.head.sha }}
          timeoutSeconds: 1800 # 30 minutes
          intervalSeconds: 30

      - name: CI check result
        run: echo "âœ… CI workflow completed successfully"

  # Wait for full test suite
  wait-for-tests:
    name: Wait for Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: pr-validation

    steps:
      - name: Wait for Test workflow
        uses: fountainhead/action-wait-for-check@v1.2.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: Test Suite Complete
          ref: ${{ github.event.pull_request.head.sha }}
          timeoutSeconds: 2700 # 45 minutes
          intervalSeconds: 30

      - name: Test check result
        run: echo "âœ… Test suite completed successfully"

  # Wait for federation validation
  wait-for-federation:
    name: Wait for Federation Validation
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: pr-validation

    steps:
      - name: Wait for Federation workflow
        uses: fountainhead/action-wait-for-check@v1.2.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: Federation Validation Complete
          ref: ${{ github.event.pull_request.head.sha }}
          timeoutSeconds: 1200 # 20 minutes
          intervalSeconds: 30

      - name: Federation check result
        run: echo "âœ… Federation validation completed successfully"

  # Check code coverage
  check-coverage:
    name: Code Coverage Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: wait-for-tests

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download coverage reports
        uses: actions/download-artifact@v4
        with:
          name: coverage-reports
          path: coverage

      - name: Check coverage thresholds
        run: |
          echo "Checking code coverage thresholds..."

          # This would parse coverage reports and check against thresholds
          # For now, just verify artifacts exist
          if [ -d "coverage" ]; then
            echo "âœ… Coverage reports found"
          else
            echo "âš ï¸ Coverage reports not found (may not have been uploaded)"
          fi

  # Verify branch is up to date with base
  check-branch-updated:
    name: Check Branch Up-to-Date
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: pr-validation

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if branch is up to date
        run: |
          git fetch origin ${{ github.base_ref }}

          # Check if PR branch is behind base branch
          BEHIND_COUNT=$(git rev-list --count HEAD..origin/${{ github.base_ref }})

          if [ "$BEHIND_COUNT" -gt 0 ]; then
            echo "âš ï¸ Branch is $BEHIND_COUNT commits behind ${{ github.base_ref }}"
            echo "Please update your branch with the latest changes from ${{ github.base_ref }}"
            exit 1
          fi

          echo "âœ… Branch is up to date with ${{ github.base_ref }}"

  # Check for required approvals
  check-approvals:
    name: Check Code Review Approvals
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [wait-for-ci, wait-for-tests, wait-for-federation]
    # Only enforce on PRs to main/master (production branches)
    if: github.base_ref == 'main' || github.base_ref == 'master'

    steps:
      - name: Check for approvals
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const approvals = reviews.filter(review => review.state === 'APPROVED');
            const requiredApprovals = 1; // Require at least 1 approval for main/master

            if (approvals.length < requiredApprovals) {
              core.setFailed(`âŒ This PR requires at least ${requiredApprovals} approval(s). Current: ${approvals.length}`);
            } else {
              console.log(`âœ… PR has ${approvals.length} approval(s)`);
            }

  # Check for sensitive files
  check-sensitive-files:
    name: Check for Sensitive Files
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: pr-validation

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44

      - name: Check for sensitive files
        run: |
          echo "Checking for sensitive files..."

          SENSITIVE_PATTERNS=(
            "*.env"
            "*.pem"
            "*.key"
            "*.p12"
            "*.pfx"
            "*credentials*"
            "*secret*"
            "*.cert"
            "*.crt"
            ".env.local"
            ".env.production"
          )

          FOUND_SENSITIVE=false

          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            for pattern in "${SENSITIVE_PATTERNS[@]}"; do
              if [[ "$file" == $pattern ]]; then
                echo "âŒ Sensitive file detected: $file"
                FOUND_SENSITIVE=true
              fi
            done
          done

          if [ "$FOUND_SENSITIVE" = true ]; then
            echo "Please remove sensitive files from your PR"
            exit 1
          fi

          echo "âœ… No sensitive files detected"

  # Check for large files
  check-file-size:
    name: Check File Sizes
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: pr-validation

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for large files
        run: |
          echo "Checking for large files (>5MB)..."

          # Find files larger than 5MB (reference PDFs in docs/reference are tracked intentionally)
          LARGE_FILES=$(find . -type f -size +5M -not -path "*/node_modules/*" -not -path "*/.git/*" -not -path "*/docs/reference/*")

          if [ -n "$LARGE_FILES" ]; then
            echo "âŒ Large files detected:"
            echo "$LARGE_FILES"
            echo "Please use Git LFS for large files or remove them"
            exit 1
          fi

          echo "âœ… No large files detected"

  # Final gate - all checks must pass
  pr-gate-complete:
    name: PR Quality Gate âœ…
    runs-on: ubuntu-latest
    needs:
      - pr-validation
      - wait-for-ci
      - wait-for-tests
      - wait-for-federation
      - check-coverage
      - check-branch-updated
      - check-sensitive-files
      - check-file-size
    # check-approvals is optional (only for main/master)

    steps:
      - name: All checks passed
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   âœ… PR Quality Gate PASSED âœ…        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "All required checks have passed:"
          echo "  âœ… PR validation"
          echo "  âœ… CI checks (lint, typecheck, build)"
          echo "  âœ… Test suite (unit, integration, RLS, GraphQL)"
          echo "  âœ… Federation validation"
          echo "  âœ… Code coverage"
          echo "  âœ… Branch up-to-date"
          echo "  âœ… No sensitive files"
          echo "  âœ… No large files"
          echo ""
          echo "This PR is ready to merge! ðŸš€"

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('PR Quality Gate')
            );

            const body = `## âœ… PR Quality Gate PASSED

            All required checks have completed successfully:

            - âœ… PR Validation
            - âœ… CI Checks (ESLint, Prettier, TypeScript, Build)
            - âœ… Test Suite (Unit, Integration, RLS, GraphQL)
            - âœ… Federation Validation (Supergraph composition, schema validation)
            - âœ… Code Coverage
            - âœ… Branch Up-to-Date
            - âœ… Security Checks (No sensitive files, no large files)

            This PR is ready to merge! ðŸš€

            ---
            *Automated by PR Quality Gate workflow*
            `;

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
